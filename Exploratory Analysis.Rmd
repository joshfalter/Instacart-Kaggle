---
title: "R Notebook"
output: html_notebook
---

This is my first [R Markdown](http://rmarkdown.rstudio.com) Notebook. Please excuse the mess.

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).
-------------------------------------------------------------------------------
```{r}
library(readr)
library(dplyr)
library(ggplot2)
library(knitr)
library(stringr)
library(DT)
library(sqldf)

setwd('C:/Users/jfalter/Dropbox/Data Science/GitHub/Instacart/')

orders <- read_csv('./orders/orders.csv')
products <- read_csv('./products.csv/products.csv')
order_products <- read_csv('./order_products__train.csv/order_products__train.csv')
order_products_prior <- read_csv('./order_products__prior.csv/order_products__prior.csv')
aisles <- read_csv('./aisles.csv/aisles.csv')
departments <- read_csv('./departments.csv/departments.csv')
```
Now I'm going to convert these to dataframes so that I can query them with SQL. This is because I like SQL and want to practice it more.
```{r}
orders<-data.frame(orders)
products<-data.frame(products)
order_products<-data.frame(order_products)
order_products_prior<-data.frame(order_products_prior)
aisles<-data.frame(aisles)
departments<-data.frame(departments)
```
So let's first see which products get reordered the most
```{r}
sqldf("SELECT product_id, SUM(reordered) as amount_reordered FROM order_products GROUP BY product_id ORDER BY amount_reordered desc LIMIT 100")
```
Now let's join the products table to this and pull the names of the products as well.
```{r}
sqldf("SELECT order_products.product_id, products.product_name, SUM(order_products.reordered) as times_reordered 
      FROM order_products 
      LEFT JOIN products 
      ON order_products.product_id = products.product_id 
      GROUP BY order_products.product_id 
      ORDER BY times_reordered desc 
      LIMIT 100")
```
Now let's look at departments by the number of products reordered
```{r}
df<-data.frame(sqldf("SELECT departments.department, SUM(order_products.reordered) FROM order_products LEFT JOIN products ON order_products.product_id=products.product_id LEFT JOIN departments ON products.department_id=departments.department_id GROUP BY departments.department ORDER BY SUM(order_products.reordered) desc LIMIT 100"))
```
Well this definitely makes sense given that most of the top products are produce.

Taking a look at the orders and products tables
```{r}
df$department<-factor(df$department, levels=df$department, ordered=TRUE)
df<-data.frame(df)
plot(x=df$department, y=df$`SUM(order_products.reordered)`, type="h")
```
Can I get the reorder graph, but broken down by department? So looking at day since last order and break down order into departments.
```{r}
kable(head(orders,12))
```
```{r}
kable(head(products,12))
```

#Counts of Order Hour of Day
```{r}
orders <- orders %>% mutate(order_hour_of_day = as.numeric(order_hour_of_day), eval_set = as.factor(eval_set))

orders %>% 
  ggplot(aes(x=order_hour_of_day)) + 
  geom_histogram
```

#Most reordered items

Number of orders per user.
```{r}
df<-sqldf("SELECT COUNT(order_id), user_id FROM orders GROUP BY user_id")
df<-data.frame(df[c(2,1)])
qplot(df$'COUNT.order_id', geom="histogram", bins=100)
```

